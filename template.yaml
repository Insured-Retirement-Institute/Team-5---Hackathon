# yaml-language-server: $schema=https://raw.githubusercontent.com/aws/serverless-application-model/main/samtranslator/schema/schema.json
AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: Agent Transfer Standard (ATS) API

Globals:
  Function:
    Timeout: 30
    Runtime: python3.12

Resources:
  TransfersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: Transfers
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      SSESpecification:
        SSEEnabled: true

  ContractsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: Contracts
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      SSESpecification:
        SSEEnabled: true

  AgentTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: Agents
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: npn
          AttributeType: S
      KeySchema:
        - AttributeName: npn
          KeyType: HASH
      SSESpecification:
        SSEEnabled: true

  StatusTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: Status
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: receivingFein
          AttributeType: S
        - AttributeName: statusKey
          AttributeType: S
      KeySchema:
        - AttributeName: receivingFein
          KeyType: HASH
        - AttributeName: statusKey
          KeyType: RANGE
      SSESpecification:
        SSEEnabled: true

  AtsApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: prod
      Description: Agent Transfer Standard (ATS) API
      Cors:
        AllowOrigin: "'*'"
        AllowHeaders: "'Content-Type,Idempotency-Key'"
        AllowMethods: "'GET,POST,PATCH,OPTIONS'"
      GatewayResponses:
        DEFAULT_4XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: "'*'"
              Access-Control-Allow-Headers: "'Content-Type,Idempotency-Key'"
        DEFAULT_5XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: "'*'"
              Access-Control-Allow-Headers: "'Content-Type,Idempotency-Key'"

  ListTransfersFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambda/
      Handler: list_transfers.lambda_handler
      Description: GET /ats/transfers — List transfers with optional npn/state/limit filters
      Events:
        ListTransfers:
          Type: Api
          Properties:
            RestApiId: !Ref AtsApi
            Path: /ats/v1/transfers
            Method: GET

  CreateTransferFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambda/
      Handler: create_transfer.lambda_handler
      Description: POST /ats/transfers — Create a new agent transfer
      Environment:
        Variables:
          TRANSFERS_TABLE: !Ref TransfersTable
          AGENT_TABLE: !Ref AgentTable
          FORWARD_API_URL_ALLIANZ: "https://mj8skppu81.execute-api.us-east-1.amazonaws.com/ats/v1/transfers"  # TODO: set to the target API URL
          FORWARD_API_URL_AE: "https://9f6yrhcul7.execute-api.us-east-1.amazonaws.com/ats/v1/transfers"  # TODO: set to the target API URL
          SET_STATUS_URL: "https://21yem0s5jl.execute-api.us-east-1.amazonaws.com/prod/ats/v1/status"
      Policies:
        - DynamoDBWritePolicy:
            TableName: !Ref TransfersTable
        - DynamoDBWritePolicy:
            TableName: !Ref AgentTable
      Events:
        CreateTransfer:
          Type: Api
          Properties:
            RestApiId: !Ref AtsApi
            Path: /ats/v1/transfers
            Method: POST

  GetTransferFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambda/
      Handler: get_transfer.lambda_handler
      Description: GET /ats/transfers/{id} — Get transfer details by id
      Environment:
        Variables:
          TRANSFERS_TABLE: !Ref TransfersTable
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref TransfersTable
      Events:
        GetTransfer:
          Type: Api
          Properties:
            RestApiId: !Ref AtsApi
            Path: /ats/v1/transfers/{id}
            Method: GET

  PatchTransferFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambda/
      Handler: patch_transfer.lambda_handler
      Description: PATCH /ats/transfers/{id} — Cancel or add a note to a transfer
      Events:
        PatchTransfer:
          Type: Api
          Properties:
            RestApiId: !Ref AtsApi
            Path: /ats/v1/transfers/{id}
            Method: PATCH

  SetStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambda/
      Handler: set_status.lambda_handler
      Description: POST /ats/status — Set carrier status for a FEIN
      Environment:
        Variables:
          STATUS_TABLE: !Ref StatusTable
          UPDATE_CONTRACTS_FEIN_URL: "https://21yem0s5jl.execute-api.us-east-1.amazonaws.com/prod/ats/v1/contracts/update-fein"
      Policies:
        - DynamoDBWritePolicy:
            TableName: !Ref StatusTable
      Events:
        SetStatus:
          Type: Api
          Properties:
            RestApiId: !Ref AtsApi
            Path: /ats/v1/status
            Method: POST

  GetStatusesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambda/
      Handler: get_statuses.lambda_handler
      Description: GET /ats/status/{fein} — Get all carrier statuses for a receiving FEIN
      Environment:
        Variables:
          STATUS_TABLE: !Ref StatusTable
          AGENT_TABLE: !Ref AgentTable
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref StatusTable
        - DynamoDBReadPolicy:
            TableName: !Ref AgentTable
      Events:
        GetStatuses:
          Type: Api
          Properties:
            RestApiId: !Ref AtsApi
            Path: /ats/v1/status/{fein}
            Method: GET

  GetContractsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambda/
      Handler: get_contracts.lambda_handler
      Description: GET /ats/contracts/{fein} — Get all contracts for a FEIN
      Environment:
        Variables:
          CONTRACTS_TABLE: !Ref ContractsTable
          AGENT_TABLE: !Ref AgentTable
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ContractsTable
        - DynamoDBReadPolicy:
            TableName: !Ref AgentTable
      Events:
        GetContracts:
          Type: Api
          Properties:
            RestApiId: !Ref AtsApi
            Path: /ats/v1/contracts/{fein}
            Method: GET

  UpdateContractsFeinFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambda/
      Handler: update_contracts_fein.lambda_handler
      Description: POST /ats/contracts/update-fein — Update contract FEINs by carrierId/npn/releasingFein
      Environment:
        Variables:
          CONTRACTS_TABLE: !Ref ContractsTable
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ContractsTable
        - DynamoDBWritePolicy:
            TableName: !Ref ContractsTable
      Events:
        UpdateContractsFein:
          Type: Api
          Properties:
            RestApiId: !Ref AtsApi
            Path: /ats/v1/contracts/update-fein
            Method: POST
            
  ReleaseTransferToCarriersFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambda/
      Handler: release_transfer_to_carriers.lambda_handler
      Description: POST /ats/v1/transfers/{id}/release — Release a transfer to carrier APIs
      Environment:
        Variables:
          TRANSFERS_TABLE: !Ref TransfersTable
          STATUS_TABLE: !Ref StatusTable
          FORWARD_API_URL_ALLIANZ: "https://mj8skppu81.execute-api.us-east-1.amazonaws.com/ats/v1/transfers"
          FORWARD_API_URL_AE: "https://9f6yrhcul7.execute-api.us-east-1.amazonaws.com/ats/v1/transfers"
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref TransfersTable
        - DynamoDBWritePolicy:
            TableName: !Ref StatusTable
      Events:
        ReleaseTransferToCarriers:
          Type: Api
          Properties:
            RestApiId: !Ref AtsApi
            Path: /ats/v1/transfers/{id}/release
            Method: POST

  ListAgentsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambda/
      Handler: agents.list_agents.lambda_handler
      Description: GET /ats/agents — List agents with carriers and books of business
      Events:
        ListAgents:
          Type: Api
          Properties:
            RestApiId: !Ref AtsApi
            Path: /ats/agents
            Method: GET

  GetAgentValidateFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambda/
      Handler: agents.get_agent_transfer.lambda_handler
      Description: GET /ats/agents/{npn}/validate — Get agent transfer validation context
      Events:
        GetAgentValidate:
          Type: Api
          Properties:
            RestApiId: !Ref AtsApi
            Path: /ats/agents/{npn}/validate
            Method: GET

  PostAgentValidateFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambda/
      Handler: agents.post_agent_transfer.lambda_handler
      Description: POST /ats/agents/{npn}/validate — Validate submitted transfer payload
      Events:
        PostAgentValidate:
          Type: Api
          Properties:
            RestApiId: !Ref AtsApi
            Path: /ats/agents/{npn}/validate
            Method: POST

Outputs:
  AtsApiUrl:
    Description: ATS API base URL
    Value: !Sub "https://${AtsApi}.execute-api.${AWS::Region}.amazonaws.com/prod"
