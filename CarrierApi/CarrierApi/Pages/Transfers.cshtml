@page
@model CarrierApi.Pages.TransfersModel
@{
    ViewData["Title"] = "ATS Transfers - " + (Environment.GetEnvironmentVariable("CARRIER_NAME") ?? "American Equity");
    var carrierName = Environment.GetEnvironmentVariable("CARRIER_NAME") ?? "American Equity";
    var cssFile = carrierName == "Allianz" ? "transfers-allianz.css" : "transfers.css";
    var logoFile = carrierName == "Allianz" ? "allianz-logo-header.svg" : "ae-logo-header.svg";
}

@section Styles {
    <link rel="stylesheet" href="~/css/@cssFile" />
}

<div class="container">
    <div class="card">
        <h2>Recent Transfer Requests</h2>
        <div id="transfersList"></div>
    </div>

    <div class="card" id="statusCard" style="display: none;">
        <h2>Process Transfer Status</h2>
        <form id="statusForm">
            <div class="form-group">
                <label>Agent NPN</label>
                <input type="text" id="npn" readonly />
            </div>
            <div class="form-group">
                <label>Receiving IMO FEIN</label>
                <input type="text" id="receivingFein" readonly />
            </div>
            <div class="form-group">
                <label>Releasing IMO FEIN</label>
                <input type="text" id="releasingFein" readonly />
            </div>
            <div class="form-group">
                <label>Transfer Status</label>
                <select id="status" class="form-control">
                    <option value="PENDING">Pending</option>
                    <option value="COMPLETED">Completed</option>
                    <option value="REJECTED">Rejected</option>
                    <option value="CANCELED">Canceled</option>
                </select>
            </div>
            
            <h3 style="color: #003d7a; font-size: 1.2rem; margin-top: 2rem; margin-bottom: 1rem;">Requirements</h3>
            <div id="requirementsList"></div>
            
            <button type="submit" class="btn">Submit Status Update</button>
        </form>
        <div id="statusResult"></div>
    </div>
</div>

@section Scripts {
    <script>
        let currentTransfer = null;
        const carrierName = '@carrierName';

        async function loadTransfers() {
            const response = await fetch('/ats/v1/transfers');
            const transfers = await response.json();
            const list = document.getElementById('transfersList');
            
            if (transfers.length === 0) {
                list.innerHTML = '<div style="padding: 1rem; color: #666;">No transfer requests yet</div>';
                return;
            }
            
            list.innerHTML = transfers.map(t => `
                <div style="background: white; border: 1px solid #dee2e6; padding: 1rem; margin-bottom: 0.5rem; border-radius: 4px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"
                     onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)';"
                     onclick="selectTransfer('${t.id}', ${t.timestamp}, ${JSON.stringify(t.request).replace(/"/g, '&quot;')})">
                    <strong>NPN: ${t.request.agent?.npn || 'N/A'}</strong> - 
                    ${new Date(t.timestamp * 1000).toLocaleString()}
                </div>
            `).join('');
        }

        window.selectTransfer = function(id, timestamp, request) {
            currentTransfer = { id, timestamp, request };
            document.getElementById("npn").value = request.agent?.npn || '';
            document.getElementById("receivingFein").value = request.receivingImo?.fein || '';
            document.getElementById("releasingFein").value = request.releasingImo?.fein || '';
            document.getElementById("status").value = "PENDING";
            
            if (carrierName === "Allianz") {
                requirements = [
                    { code: "LetterOfInstruction", status: "PENDING", details: "" },
                    { code: "TermsAndConditions", status: "PENDING", details: "" }
                ];
            } else {
                requirements = [
                    { code: "LetterOfInstruction", status: "PENDING", details: "" }
                ];
            }
            
            updateRequirementsList();
            document.getElementById("statusResult").textContent = "";
            document.getElementById("statusCard").style.display = "block";
            sendStatus();
        };

        setInterval(loadTransfers, 3000);
        loadTransfers();

        let requirements = [];

        function updateRequirementsList() {
            const list = document.getElementById("requirementsList");
            list.innerHTML = requirements.map((r, i) => `
                <div style="background: white; border: 1px solid #dee2e6; padding: 1rem; margin-bottom: 0.5rem; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                    <div><strong>${r.code}</strong> - ${r.status}${r.details ? ' - ' + r.details : ''}</div>
                    <div>
                        <button type="button" onclick="completeRequirement(${i})" style="background: #28a745; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; margin-right: 0.5rem;">Complete</button>
                        <button type="button" onclick="rejectRequirement(${i})" style="background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Reject</button>
                    </div>
                </div>
            `).join('');
        }

        window.completeRequirement = function(index) {
            requirements[index].status = "COMPLETED";
            requirements[index].details = "";
            updateRequirementsList();
            sendStatus();
        };

        window.rejectRequirement = function(index) {
            const reason = prompt("Enter rejection reason:");
            if (reason !== null) {
                requirements[index].status = "REJECTED";
                requirements[index].details = reason;
                updateRequirementsList();
                sendStatus();
            }
        };

        document.getElementById("status").addEventListener("change", sendStatus);

        function sendStatus() {
            const status = {
                npn: document.getElementById("npn").value,
                receivingFein: document.getElementById("receivingFein").value,
                releasingFein: document.getElementById("releasingFein").value,
                carrierId: "american-equity",
                status: document.getElementById("status").value,
                requirements: requirements
            };
            fetch('/ats/v1/status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(status)
            }).catch(err => console.error("Error sending status:", err));
        }

        document.getElementById("statusForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            sendStatus();
            const result = document.getElementById("statusResult");
            result.className = "status-result success";
            result.textContent = "âœ“ Status sent successfully";
            alert("Status sent successfully!");
        });
    </script>
}
