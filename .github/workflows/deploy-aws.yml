name: Deploy to AWS Sandbox Lambda

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.SANDBOX_AWS_REGION }}
  LAMBDA_FUNCTION_NAME: ${{ vars.SANDBOX_LAMBDA_FUNCTION_NAME }}

jobs:
  deploy-sandbox:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required repository variables
        run: |
          set -euo pipefail
          required=(AWS_REGION LAMBDA_FUNCTION_NAME)
          for v in "${required[@]}"; do
            if [ -z "${!v:-}" ]; then
              echo "Missing required repository variable: $v"
              exit 1
            fi
          done

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.SANDBOX_AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build Lambda package
        run: |
          set -euo pipefail
          rm -rf package receiver-lambda.zip
          mkdir -p package
          pip install --upgrade pip
          pip install -r src/webhooks/receiver/requirements.txt -t package
          cp src/webhooks/receiver/app.py package/
          cp src/webhooks/receiver/handler.py package/
          cd package
          zip -r ../receiver-lambda.zip .

      - name: Deploy Lambda code
        run: |
          set -euo pipefail
          aws lambda update-function-code \
            --function-name "$LAMBDA_FUNCTION_NAME" \
            --zip-file fileb://receiver-lambda.zip \
            --publish >/dev/null

          aws lambda wait function-updated \
            --function-name "$LAMBDA_FUNCTION_NAME"

      - name: Deployment summary
        run: |
          echo "Deployed package: receiver-lambda.zip"
          echo "Environment: sandbox"
          echo "Lambda Function: $LAMBDA_FUNCTION_NAME"
