name: Deploy to AWS Sandbox ECS

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.SANDBOX_AWS_REGION }}
  ECR_REPOSITORY: ${{ vars.SANDBOX_ECR_REPOSITORY }}
  ECS_CLUSTER: ${{ vars.SANDBOX_ECS_CLUSTER }}
  ECS_SERVICE: ${{ vars.SANDBOX_ECS_SERVICE }}
  ECS_TASK_FAMILY: ${{ vars.SANDBOX_ECS_TASK_FAMILY }}
  ECS_CONTAINER_NAME: ${{ vars.SANDBOX_ECS_CONTAINER_NAME }}

jobs:
  deploy-sandbox:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required repository variables
        run: |
          set -euo pipefail
          required=(AWS_REGION ECR_REPOSITORY ECS_CLUSTER ECS_SERVICE ECS_TASK_FAMILY ECS_CONTAINER_NAME)
          for v in "${required[@]}"; do
            if [ -z "${!v:-}" ]; then
              echo "Missing required repository variable: $v"
              exit 1
            fi
          done

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.SANDBOX_AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Ensure ECR repository exists
        run: |
          set -euo pipefail
          aws ecr describe-repositories --repository-names "$ECR_REPOSITORY" >/dev/null 2>&1 || \
          aws ecr create-repository --repository-name "$ECR_REPOSITORY" >/dev/null

      - name: Build and push image
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          set -euo pipefail
          IMAGE_URI="$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          docker build -f src/webhooks/receiver/Dockerfile -t "$IMAGE_URI" .
          docker push "$IMAGE_URI"
          echo "image=$IMAGE_URI" >> "$GITHUB_OUTPUT"

      - name: Create updated task definition
        id: task-def
        env:
          IMAGE_URI: ${{ steps.build-image.outputs.image }}
        run: |
          set -euo pipefail
          aws ecs describe-task-definition \
            --task-definition "$ECS_TASK_FAMILY" \
            --query taskDefinition > task-definition.json

          jq \
            --arg IMAGE_URI "$IMAGE_URI" \
            --arg CONTAINER_NAME "$ECS_CONTAINER_NAME" \
            'del(
              .taskDefinitionArn,
              .revision,
              .status,
              .requiresAttributes,
              .compatibilities,
              .registeredAt,
              .registeredBy,
              .deregisteredAt
            )
            | .containerDefinitions = (
                .containerDefinitions
                | map(if .name == $CONTAINER_NAME then .image = $IMAGE_URI else . end)
              )' \
            task-definition.json > new-task-definition.json

          NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://new-task-definition.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)

          echo "task_def_arn=$NEW_TASK_DEF_ARN" >> "$GITHUB_OUTPUT"

      - name: Deploy to ECS service
        env:
          TASK_DEF_ARN: ${{ steps.task-def.outputs.task_def_arn }}
        run: |
          set -euo pipefail
          aws ecs update-service \
            --cluster "$ECS_CLUSTER" \
            --service "$ECS_SERVICE" \
            --task-definition "$TASK_DEF_ARN" \
            --force-new-deployment >/dev/null

          aws ecs wait services-stable \
            --cluster "$ECS_CLUSTER" \
            --services "$ECS_SERVICE"

      - name: Deployment summary
        run: |
          echo "Deployed image: ${{ steps.build-image.outputs.image }}"
          echo "Environment: sandbox"
          echo "ECS Cluster: $ECS_CLUSTER"
          echo "ECS Service: $ECS_SERVICE"
