<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ATS â€” Transfer Assistant</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --navy:    #0f2044;
      --accent:  #2f80ed;
      --accent-h:#1a6ed8;
      --bg:      #f0eaf8;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow: hidden;
      color: #1a1a2e;
    }

    /* â”€â”€ Animated background blobs â”€â”€ */
    .bg-blobs {
      position: fixed;
      inset: 0;
      z-index: 0;
      overflow: hidden;
      pointer-events: none;
    }
    .blob {
      position: absolute;
      border-radius: 50%;
      filter: blur(70px);
      opacity: 0.28;
    }
    .blob-1 {
      width: 520px; height: 520px;
      background: radial-gradient(circle, #d8b4fe, #c084fc);
      top: -120px; left: -100px;
      animation: blob-drift-1 14s ease-in-out infinite;
    }
    .blob-2 {
      width: 440px; height: 440px;
      background: radial-gradient(circle, #f9a8d4, #f472b6);
      top: 10%; right: -80px;
      animation: blob-drift-2 17s ease-in-out infinite;
    }
    .blob-3 {
      width: 400px; height: 400px;
      background: radial-gradient(circle, #e879f9, #a855f7);
      bottom: -60px; left: 20%;
      animation: blob-drift-3 20s ease-in-out infinite;
    }
    .blob-4 {
      width: 300px; height: 300px;
      background: radial-gradient(circle, #fda4af, #fb7185);
      bottom: 15%; right: 10%;
      animation: blob-drift-4 12s ease-in-out infinite;
    }

    @keyframes blob-drift-1 {
      0%,100% { transform: translate(0px,   0px)  scale(1);    }
      33%      { transform: translate(60px,  80px) scale(1.08); }
      66%      { transform: translate(-30px, 50px) scale(0.94); }
    }
    @keyframes blob-drift-2 {
      0%,100% { transform: translate(0px,   0px)   scale(1);    }
      33%      { transform: translate(-70px, 60px)  scale(1.06); }
      66%      { transform: translate(40px,  -50px) scale(0.96); }
    }
    @keyframes blob-drift-3 {
      0%,100% { transform: translate(0px,   0px)   scale(1);    }
      40%      { transform: translate(80px,  -70px) scale(1.1);  }
      70%      { transform: translate(-40px, -30px) scale(0.92); }
    }
    @keyframes blob-drift-4 {
      0%,100% { transform: translate(0px,  0px)   scale(1);    }
      50%      { transform: translate(-60px,-50px) scale(1.12); }
    }

    /* ensure everything sits above blobs */
    .header, .center { position: relative; z-index: 1; }

    /* â”€â”€ Header â”€â”€ */
    .header {
      width: 100%;
      padding: 0 28px;
      height: 52px;
      background: var(--navy);
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
    }
    .logo-mark {
      width: 30px; height: 30px;
      background: var(--accent);
      border-radius: 7px;
      display: flex; align-items: center; justify-content: center;
      font-weight: 800; font-size: 13px; color: #fff;
      letter-spacing: -0.5px;
    }
    .logo-text { color: #fff; font-size: 15px; font-weight: 600; }
    .logo-text span { color: #7eb8f7; font-weight: 400; }
    .header-spacer { flex: 1; }
    .status-dot {
      font-size: 12px; color: #7eb8f7;
      display: flex; align-items: center; gap: 5px;
    }
    .status-dot::before {
      content: ''; width: 7px; height: 7px;
      background: #34c759; border-radius: 50%;
      display: inline-block; box-shadow: 0 0 4px #34c759;
    }

    /* â”€â”€ Center row layout â”€â”€ */
    .center {
      flex: 1;
      display: flex;
      flex-direction: row;
      align-items: stretch;
      width: 100%;
      padding: 20px 28px 20px 24px;
      gap: 28px;
      overflow: hidden;
      min-height: 0;
    }

    /* â”€â”€ Left panel (orb + heading) â”€â”€ */
    .left-panel {
      width: 190px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 14px;
    }

    /* â”€â”€ Cosmic Ball â”€â”€ */
    .orb-wrap {
      flex-shrink: 0;
      margin-bottom: 0;
      position: relative;
      width: 120px;
      height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .orb-core {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: radial-gradient(circle at 35% 35%,
        #f0d0ff 0%,
        #c084fc 22%,
        #a855f7 45%,
        #7c3aed 68%,
        #3b0764 100%
      );
      box-shadow:
        0 0 30px rgba(168, 85, 247, 0.8),
        0 0 70px rgba(168, 85, 247, 0.5),
        0 0 120px rgba(236, 72, 153, 0.3);
      position: relative;
      z-index: 2;
      animation: orb-pulse 4s ease-in-out infinite;
    }

    @keyframes orb-pulse {
      0%, 100% {
        box-shadow:
          0 0 30px rgba(168, 85, 247, 0.75),
          0 0 70px rgba(168, 85, 247, 0.45),
          0 0 120px rgba(236, 72, 153, 0.25);
        transform: scale(1);
      }
      50% {
        box-shadow:
          0 0 40px rgba(168, 85, 247, 1),
          0 0 100px rgba(168, 85, 247, 0.65),
          0 0 160px rgba(236, 72, 153, 0.45);
        transform: scale(1.05);
      }
    }

    .orb-core::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background-image:
        radial-gradient(1.5px 1.5px at 20% 25%, rgba(255,255,255,0.95) 0%, transparent 100%),
        radial-gradient(1px 1px at 65% 18%, rgba(255,255,255,0.8) 0%, transparent 100%),
        radial-gradient(1.2px 1.2px at 78% 55%, rgba(255,255,255,0.85) 0%, transparent 100%),
        radial-gradient(1px 1px at 35% 70%, rgba(255,255,255,0.7) 0%, transparent 100%),
        radial-gradient(0.8px 0.8px at 55% 42%, rgba(255,255,255,0.9) 0%, transparent 100%),
        radial-gradient(1px 1px at 15% 58%, rgba(255,255,255,0.65) 0%, transparent 100%),
        radial-gradient(0.7px 0.7px at 70% 30%, rgba(255,255,255,0.75) 0%, transparent 100%),
        radial-gradient(1px 1px at 48% 82%, rgba(255,255,255,0.55) 0%, transparent 100%);
    }

    .haze {
      position: absolute;
      border-radius: 50%;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }
    .haze-1 {
      width: 82px; height: 82px;
      background: conic-gradient(
        from 0deg,
        transparent 0%, rgba(168,85,247,0.55) 18%, rgba(236,72,153,0.4) 38%,
        transparent 52%, rgba(99,102,241,0.45) 72%, transparent 100%
      );
      animation: spin-cw 6s linear infinite;
      filter: blur(10px);
    }
    .haze-2 {
      width: 104px; height: 104px;
      background: conic-gradient(
        from 120deg,
        transparent 0%, rgba(236,72,153,0.4) 22%, rgba(168,85,247,0.5) 48%,
        transparent 62%, rgba(139,92,246,0.3) 82%, transparent 100%
      );
      animation: spin-ccw 9s linear infinite;
      filter: blur(16px);
    }
    .haze-3 {
      width: 126px; height: 126px;
      background: conic-gradient(
        from 240deg,
        transparent 0%, rgba(99,102,241,0.3) 28%, rgba(236,72,153,0.22) 52%,
        transparent 68%, rgba(168,85,247,0.28) 86%, transparent 100%
      );
      animation: spin-cw 14s linear infinite;
      filter: blur(22px);
    }

    .arc {
      position: absolute;
      top: 50%; left: 50%;
      border-radius: 50%;
      border: 1px solid transparent;
      transform: translate(-50%, -50%);
    }
    .arc-1 {
      width: 82px; height: 82px;
      border-top-color: rgba(168,85,247,0.7);
      border-left-color: rgba(236,72,153,0.45);
      animation: spin-cw 4s linear infinite;
    }
    .arc-2 {
      width: 100px; height: 100px;
      border-bottom-color: rgba(236,72,153,0.6);
      border-right-color: rgba(99,102,241,0.4);
      animation: spin-ccw 7s linear infinite;
    }
    .arc-3 {
      width: 118px; height: 118px;
      border-top-color: rgba(99,102,241,0.4);
      border-right-color: rgba(168,85,247,0.3);
      animation: spin-cw 11s linear infinite;
    }

    @keyframes spin-cw  { from { transform: translate(-50%,-50%) rotate(0deg);   } to { transform: translate(-50%,-50%) rotate(360deg);  } }
    @keyframes spin-ccw { from { transform: translate(-50%,-50%) rotate(0deg);   } to { transform: translate(-50%,-50%) rotate(-360deg); } }

    /* â”€â”€ Heading â”€â”€ */
    .heading { text-align: center; flex-shrink: 0; }
    .heading h1 { font-size: 18px; font-weight: 700; color: #3b1a5e; letter-spacing: -0.3px; }
    .heading p  { margin-top: 5px; font-size: 12px; color: #8b5aaa; line-height: 1.5; }

    /* â”€â”€ Chat card â”€â”€ */
    .chat-card {
      flex: 1;
      background: rgba(255,255,255,0.55);
      backdrop-filter: blur(16px);
      border-radius: 16px;
      border: 1px solid rgba(168,85,247,0.15);
      box-shadow: 0 2px 8px rgba(120,0,120,0.08), 0 8px 32px rgba(180,80,180,0.1);
      display: flex; flex-direction: column;
      overflow: hidden; min-height: 0;
    }

    /* â”€â”€ Messages â”€â”€ */
    .messages {
      flex: 1; overflow-y: auto;
      padding: 22px 24px;
      display: flex; flex-direction: column; gap: 14px;
    }
    .messages::-webkit-scrollbar { width: 4px; }
    .messages::-webkit-scrollbar-thumb { background: rgba(168,85,247,0.25); border-radius: 4px; }

    .msg-row { display: flex; gap: 10px; align-items: flex-end; }
    .msg-row.user { flex-direction: row-reverse; }

    .msg-avatar {
      width: 28px; height: 28px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 11px; font-weight: 700; flex-shrink: 0;
    }
    .msg-avatar.agent-av { background: #ede9fe; color: #7c3aed; }
    .msg-avatar.user-av  { background: var(--navy); color: #90b8e8; }

    .message {
      max-width: 74%; padding: 10px 15px; border-radius: 18px;
      font-size: 13.5px; line-height: 1.6;
      white-space: pre-wrap; word-break: break-word;
    }
    .msg-row.agent .message {
      background: rgba(255,255,255,0.75);
      color: #2d1a4a;
      border-bottom-left-radius: 4px;
    }
    /* â”€â”€ User bubble color â€” edit #9333ea (purple) and #ec4899 (pink) to change â”€â”€ */
    .msg-row.user .message {
      background: linear-gradient(135deg, #9333ea, #ec4899);
      color: #fff;
      border-bottom-right-radius: 4px;
      box-shadow: 0 2px 12px rgba(168,85,247,0.4), 0 4px 24px rgba(236,72,153,0.25);
    }
    .msg-row.error .message {
      background: rgba(255,80,80,0.1);
      color: #c0392b;
      border-bottom-left-radius: 4px;
    }
    .typing .message {
      background: rgba(255,255,255,0.6);
      color: #a855c8;
      font-size: 18px; letter-spacing: 4px; padding: 8px 16px;
    }

    /* â”€â”€ Input â”€â”€ */
    .input-area {
      display: flex; gap: 10px;
      padding: 14px 18px;
      border-top: 1px solid rgba(168,85,247,0.15);
      background: rgba(255,255,255,0.4);
    }
    #user-input {
      flex: 1; padding: 10px 16px;
      border: 1.5px solid rgba(168,85,247,0.3); border-radius: 24px;
      font-size: 13.5px; outline: none; resize: none;
      font-family: inherit; line-height: 1.45;
      max-height: 120px; overflow-y: auto;
      background: rgba(255,255,255,0.7); color: #2d1a4a;
      transition: border-color 0.15s, background 0.15s;
    }
    #user-input:focus { border-color: #a855f7; background: rgba(255,255,255,0.9); }
    #user-input::placeholder { color: rgba(139,90,170,0.5); }

    #send-btn {
      padding: 10px 22px;
      background: linear-gradient(135deg, #7c3aed, #db2777);
      color: #fff; border: none; border-radius: 24px;
      font-size: 13.5px; font-weight: 600; cursor: pointer;
      white-space: nowrap; display: flex; align-items: center; gap: 6px;
      transition: opacity 0.15s; flex-shrink: 0;
    }
    #send-btn:hover    { opacity: 0.88; }
    #send-btn:disabled { opacity: 0.45; cursor: not-allowed; }

    /* â”€â”€ Attach button â”€â”€ */
    #attach-btn {
      padding: 10px 12px;
      background: rgba(168,85,247,0.08);
      color: #7c3aed; border: 1.5px solid rgba(168,85,247,0.25);
      border-radius: 24px; cursor: pointer;
      font-size: 15px; line-height: 1;
      transition: background 0.15s; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
    }
    #attach-btn:hover { background: rgba(168,85,247,0.16); }
    #attach-btn.has-doc { background: rgba(168,85,247,0.2); border-color: #a855f7; }

    /* â”€â”€ Doc chip bar â”€â”€ */
    .doc-chip-bar {
      padding: 6px 18px;
      background: rgba(168,85,247,0.06);
      border-top: 1px solid rgba(168,85,247,0.12);
      display: flex; align-items: center; gap: 7px;
      font-size: 12px; color: #6b2d9e;
      flex-shrink: 0;
    }
    .doc-chip-bar span { font-weight: 600; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .doc-clear-btn {
      background: none; border: none; cursor: pointer;
      color: #a855f7; font-size: 15px; line-height: 1;
      padding: 0 3px; border-radius: 4px;
      transition: background 0.15s; flex-shrink: 0;
    }
    .doc-clear-btn:hover { background: rgba(168,85,247,0.12); }

    /* â”€â”€ Doc context label (shown under user bubble) â”€â”€ */
    .doc-context-label {
      display: flex;
      justify-content: flex-end;
      padding-right: 38px;
      margin-top: -6px;
    }
    .doc-context-pill {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 11.5px;
      font-weight: 600;
      color: #7c3aed;
      background: rgba(168,85,247,0.13);
      border: 1.5px solid rgba(168,85,247,0.3);
      border-radius: 20px;
      padding: 3px 10px 3px 8px;
      letter-spacing: 0.1px;
    }

    /* â”€â”€ Inline form card â”€â”€ */
    .form-card {
      max-width: 74%;
      background: rgba(255,255,255,0.88);
      border: 1.5px solid rgba(168,85,247,0.25);
      border-radius: 14px;
      padding: 18px 20px 14px;
      box-shadow: 0 2px 14px rgba(168,85,247,0.12);
    }
    .form-card-title {
      font-size: 12.5px; font-weight: 700; color: #7c3aed;
      margin-bottom: 14px; display: flex; align-items: center; gap: 6px;
    }
    .form-field { margin-bottom: 11px; }
    .form-field label {
      display: block; font-size: 11px; font-weight: 600;
      color: #6b2d9e; margin-bottom: 4px; letter-spacing: 0.2px;
    }
    .form-field input, .form-field select {
      width: 100%; padding: 7px 11px;
      border: 1.5px solid rgba(168,85,247,0.22); border-radius: 8px;
      font-size: 13px; font-family: inherit; color: #2d1a4a;
      background: rgba(255,255,255,0.9); outline: none;
      transition: border-color 0.15s;
    }
    .form-field input:focus, .form-field select:focus { border-color: #a855f7; }
    .form-actions {
      display: flex; gap: 8px; justify-content: flex-end; margin-top: 14px;
    }
    .form-cancel-btn {
      padding: 7px 15px;
      border: 1.5px solid rgba(168,85,247,0.3); border-radius: 20px;
      background: transparent; color: #7c3aed;
      font-size: 12px; font-weight: 600; cursor: pointer;
      transition: background 0.15s;
    }
    .form-cancel-btn:hover { background: rgba(168,85,247,0.07); }
    .form-submit-btn {
      padding: 7px 18px;
      background: linear-gradient(135deg, #7c3aed, #db2777);
      color: #fff; border: none; border-radius: 20px;
      font-size: 12px; font-weight: 600; cursor: pointer;
      transition: opacity 0.15s;
    }
    .form-submit-btn:hover { opacity: 0.88; }
  </style>
</head>
<body>

  <div class="bg-blobs">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>
    <div class="blob blob-4"></div>
  </div>

  <header class="header">
    <div class="logo-mark">ATS</div>
    <div class="logo-text">Transfer<span>Portal</span></div>
    <div class="header-spacer"></div>
    <div class="status-dot">Agent Online</div>
  </header>

  <div class="center">

    <div class="left-panel">
      <div class="orb-wrap">
        <div class="haze-3 haze"></div>
        <div class="haze-2 haze"></div>
        <div class="haze-1 haze"></div>
        <div class="arc arc-3"></div>
        <div class="arc arc-2"></div>
        <div class="arc arc-1"></div>
        <div class="orb-core"></div>
      </div>
      <div class="heading">
        <h1>Agent Transfer Assistant</h1>
        <p>Create transfers, check status, and manage agent contracts</p>
      </div>
    </div>

    <div class="chat-card">
      <div class="messages" id="messages">
        <div class="msg-row agent">
          <div class="msg-avatar agent-av">AI</div>
          <div class="message">Hi! I can help you create, view, and manage agent transfers between IMOs. What would you like to do today?</div>
        </div>
      </div>

      <div class="doc-chip-bar" id="doc-chip-bar" style="display:none">
        ðŸ“„ <span id="doc-name"></span>
        <button class="doc-clear-btn" id="clear-doc-btn" title="Remove document">Ã—</button>
      </div>

      <div class="input-area">
        <input type="file" id="file-input" accept=".docx,.txt" style="display:none">
        <button id="attach-btn" title="Attach a .docx or .txt document">ðŸ“Ž</button>
        <textarea id="user-input" rows="1" placeholder="Ask me to create a transfer, check status, or look up an agentâ€¦"></textarea>
        <button id="send-btn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <line x1="22" y1="2" x2="11" y2="13"/>
            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
          </svg>
          Send
        </button>
      </div>
    </div>

  </div>

  <script>
    const messagesEl  = document.getElementById('messages');
    const inputEl     = document.getElementById('user-input');
    const sendBtn     = document.getElementById('send-btn');
    const attachBtn   = document.getElementById('attach-btn');
    const fileInput   = document.getElementById('file-input');
    const docChipBar  = document.getElementById('doc-chip-bar');
    const docNameEl   = document.getElementById('doc-name');
    const clearDocBtn = document.getElementById('clear-doc-btn');

    // â”€â”€ Document upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    attachBtn.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', async () => {
      const file = fileInput.files[0];
      if (!file) return;
      fileInput.value = '';

      const formData = new FormData();
      formData.append('file', file);

      attachBtn.disabled = true;
      try {
        const res  = await fetch('/upload', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.error) {
          addMessage('Could not attach document: ' + data.error, 'error');
          return;
        }
        docNameEl.textContent = data.filename + (data.truncated ? ' (truncated)' : '');
        docChipBar.style.display = 'flex';
        attachBtn.classList.add('has-doc');
      } catch (err) {
        addMessage('Upload failed â€” please try again.', 'error');
      } finally {
        attachBtn.disabled = false;
      }
    });

    clearDocBtn.addEventListener('click', async () => {
      await fetch('/clear-doc', { method: 'POST' });
      docChipBar.style.display = 'none';
      docNameEl.textContent = '';
      attachBtn.classList.remove('has-doc');
    });

    function scrollToBottom() { messagesEl.scrollTop = messagesEl.scrollHeight; }

    function addMessage(text, role) {
      const row = document.createElement('div');
      row.className = `msg-row ${role}`;

      if (role !== 'user') {
        const av = document.createElement('div');
        av.className = 'msg-avatar agent-av';
        av.textContent = role === 'error' ? '!' : 'AI';
        row.appendChild(av);
      }

      const bubble = document.createElement('div');
      bubble.className = 'message';
      bubble.textContent = text;
      row.appendChild(bubble);

      if (role === 'user') {
        const av = document.createElement('div');
        av.className = 'msg-avatar user-av';
        av.textContent = 'ME';
        row.appendChild(av);
      }

      messagesEl.appendChild(row);
      scrollToBottom();
      return row;
    }

    function addFormCard(formSpec) {
      const row = document.createElement('div');
      row.className = 'msg-row agent';

      const av = document.createElement('div');
      av.className = 'msg-avatar agent-av';
      av.textContent = 'AI';
      row.appendChild(av);

      const card = document.createElement('div');
      card.className = 'form-card';

      const title = document.createElement('div');
      title.className = 'form-card-title';
      title.textContent = 'ðŸ“‹ ' + (formSpec.title || 'Form');
      card.appendChild(title);

      const fields = formSpec.fields || [];
      const inputs = {};

      fields.forEach(field => {
        const fieldDiv = document.createElement('div');
        fieldDiv.className = 'form-field';

        const label = document.createElement('label');
        label.textContent = field.label + (field.required ? ' *' : '');
        fieldDiv.appendChild(label);

        let input;
        if (field.type === 'select' && field.options) {
          input = document.createElement('select');
          const blank = document.createElement('option');
          blank.value = ''; blank.textContent = 'â€” select â€”';
          input.appendChild(blank);
          field.options.forEach(opt => {
            const o = document.createElement('option');
            o.value = opt; o.textContent = opt;
            input.appendChild(o);
          });
        } else {
          input = document.createElement('input');
          input.type = field.type || 'text';
          if (field.placeholder) input.placeholder = field.placeholder;
        }
        inputs[field.key] = { input, field };
        fieldDiv.appendChild(input);
        card.appendChild(fieldDiv);
      });

      const actions = document.createElement('div');
      actions.className = 'form-actions';

      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'form-cancel-btn';
      cancelBtn.textContent = 'Cancel';
      cancelBtn.onclick = () => messagesEl.removeChild(row);

      const submitBtn = document.createElement('button');
      submitBtn.className = 'form-submit-btn';
      submitBtn.textContent = 'Submit â–¶';
      submitBtn.onclick = () => {
        const parts = fields
          .map(f => {
            const val = inputs[f.key].input.value.trim();
            return val ? `${f.label}: ${val}` : null;
          })
          .filter(Boolean);
        if (parts.length === 0) return;
        messagesEl.removeChild(row);
        inputEl.value = parts.join(', ');
        sendMessage();
      };

      actions.appendChild(cancelBtn);
      actions.appendChild(submitBtn);
      card.appendChild(actions);
      row.appendChild(card);
      messagesEl.appendChild(row);
      scrollToBottom();
    }

    async function sendMessage() {
      const text = inputEl.value.trim();
      if (!text) return;

      inputEl.value = '';
      inputEl.style.height = 'auto';
      sendBtn.disabled = true;
      addMessage(text, 'user');

      // If a document is attached, show a pill under the user bubble then auto-clear
      const attachedDoc = docChipBar.style.display !== 'none' ? docNameEl.textContent : null;
      if (attachedDoc) {
        const label = document.createElement('div');
        label.className = 'doc-context-label';
        const pill = document.createElement('span');
        pill.className = 'doc-context-pill';
        pill.textContent = 'ðŸ“„ ' + attachedDoc;
        label.appendChild(pill);
        messagesEl.appendChild(label);
        scrollToBottom();

        // Auto-remove the doc so it only applies to this one message
        fetch('/clear-doc', { method: 'POST' });
        docChipBar.style.display = 'none';
        docNameEl.textContent = '';
        attachBtn.classList.remove('has-doc');
      }

      const typingRow = document.createElement('div');
      typingRow.className = 'msg-row agent typing';
      const typingAv = document.createElement('div');
      typingAv.className = 'msg-avatar agent-av';
      typingAv.textContent = 'AI';
      const typingBubble = document.createElement('div');
      typingBubble.className = 'message';
      typingBubble.textContent = 'Â·Â·Â·';
      typingRow.appendChild(typingAv);
      typingRow.appendChild(typingBubble);
      messagesEl.appendChild(typingRow);
      scrollToBottom();

      try {
        const res = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text }),
        });
        const data = await res.json();
        messagesEl.removeChild(typingRow);
        addMessage(data.error ? 'Error: ' + data.error : data.reply, data.error ? 'error' : 'agent');
        if (data.form) addFormCard(data.form);
      } catch (err) {
        messagesEl.removeChild(typingRow);
        addMessage('Network error â€” please try again.', 'error');
      } finally {
        sendBtn.disabled = false;
        inputEl.focus();
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });
    inputEl.addEventListener('input', () => {
      inputEl.style.height = 'auto';
      inputEl.style.height = inputEl.scrollHeight + 'px';
    });
  </script>
</body>
</html>